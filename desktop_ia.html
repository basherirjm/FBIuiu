<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FBI OS - Desktop (IA)</title>

  <link rel="stylesheet" href="desktop_base.css">
  <link rel="stylesheet" href="desktop_ia.css">

  <!-- Anti "flash" avant vérif session -->
  <style>body{visibility:hidden;}</style>
</head>
<body>
  <div class="background-grid"></div>

  <div class="hud">
    <div class="hud-left">
      <div class="hud-logo">FBI OS</div>
      <div class="hud-sub">INTERNAL AFFAIRS • OVERSIGHT DESKTOP</div>
    </div>
    <div class="hud-right">
      <div class="pill"><span class="pulse"></span><span>COMPLIANCE: ACTIVE</span></div>
      <div class="pill"><span>INVESTIGATOR:</span><span id="agent-name">UNKNOWN</span></div>
      <div class="pill"><span id="hud-time">--/--/---- --:--:--</span></div>
    </div>
  </div>

  <div class="desktop" id="desktop">
    <div class="side">
      <div class="title">
        <h3>OVERSIGHT BRIEF</h3>
        <div class="tag">IA CLEARANCE</div>
      </div>
      <div class="row"><span>MODULE</span><span>DRIVE (ALL SCOPES)</span></div>
      <div class="row"><span>USERS</span><span>ADMIN PANEL</span></div>
      <div class="row"><span>LOGS</span><span>GLOBAL</span></div>
      <div class="row"><span>SHARING</span><span>PI / MOOT / IA / ALL</span></div>

      <div class="actions">
        <button class="btn" id="btn-lock">Lock</button>
        <button class="btn" id="btn-logout">Logout</button>
      </div>
    </div>

    <div class="icons" id="iconGrid">
      <div class="icon" data-open="win-drive" tabindex="0">
        <div class="glyph">#</div>
        <div class="label">Drive</div>
        <div class="hint">All scopes, full control</div>
      </div>

      <div class="icon" data-open="win-admin" tabindex="0">
        <div class="glyph">*</div>
        <div class="label">User Admin</div>
        <div class="hint">Create / disable / role / reset</div>
      </div>

      <div class="icon" data-open="win-logs" tabindex="0">
        <div class="glyph">!</div>
        <div class="label">Server Logs</div>
        <div class="hint">All users</div>
      </div>
    </div>

    <div class="watermark">IA • OVERSIGHT • UNAUTHORIZED ACCESS PROHIBITED</div>

    <!-- DRIVE -->
    <div class="window hidden" id="win-drive" style="top:110px; left: 420px; width: 880px; height: 520px;">
      <div class="titlebar" data-drag>
        <div class="win-title"><span class="miniicon">#</span> DRIVE</div>
        <div class="win-controls">
          <div class="ctl" data-min="win-drive">_</div>
          <div class="ctl" data-close="win-drive">×</div>
        </div>
      </div>
      <div class="content">
        <div class="section">
          <div class="drive-top">
            <div class="drive-path" id="drive-path">ROOT</div>
            <div class="drive-controls">
              <button class="mini" id="drive-back">BACK</button>
              <select class="field small" id="drive-scope"></select>
              <button class="mini" id="drive-newfolder">NEW FOLDER</button>
              <button class="mini" id="drive-newtext">NEW TEXT</button>
              <button class="mini" id="drive-upload">UPLOAD</button>
            </div>
          </div>
          <div class="drive-grid">
            <div>
              <h4>FOLDERS</h4>
              <div id="drive-folders"></div>
            </div>
            <div>
              <h4>FILES</h4>
              <div id="drive-files"></div>
            </div>
          </div>
          <div class="empty" id="drive-status" style="margin-top:10px;">…</div>
        </div>
      </div>
      <div class="resizer" data-resize></div>
    </div>

    <!-- EDITOR -->
    <div class="window hidden" id="win-editor" style="top:140px; left: 520px; width: 820px; height: 520px;">
      <div class="titlebar" data-drag>
        <div class="win-title">
          <span class="miniicon">Ω</span>
          <span id="editor-title">EDITOR</span>
          <span class="badge" id="editor-scope">--</span>
          <span class="editor-ro" id="editor-ro">READ ONLY</span>
        </div>
        <div class="win-controls">
          <div class="ctl" data-min="win-editor">_</div>
          <div class="ctl" data-close="win-editor">×</div>
        </div>
      </div>
      <div class="content">
        <div class="section">
          <h4>CONTENT</h4>
          <textarea class="field" id="editor-text" style="height:320px; resize:none;" placeholder="Open a text file from Drive…"></textarea>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" id="editor-save">Save</button>
            <button class="btn" id="editor-rename">Rename</button>
            <button class="btn" id="editor-delete">Delete</button>
          </div>
        </div>
      </div>
      <div class="resizer" data-resize></div>
    </div>

    <!-- ADMIN -->
    <div class="window hidden" id="win-admin" style="top:120px; left: 380px; width: 980px; height: 560px;">
      <div class="titlebar" data-drag>
        <div class="win-title"><span class="miniicon">*</span> USER ADMIN</div>
        <div class="win-controls">
          <div class="ctl" data-min="win-admin">_</div>
          <div class="ctl" data-close="win-admin">×</div>
        </div>
      </div>
      <div class="content">
        <div class="section">
          <h4>CREATE USER</h4>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <input class="field" id="admin-username" style="flex:1; min-width:220px;" placeholder="USERNAME (A-Z0-9_-)" autocomplete="off">
            <input class="field" id="admin-password" style="flex:1; min-width:220px;" placeholder="PASSWORD" autocomplete="off">
            <select class="field small" id="admin-role">
              <option value="PI">PI</option>
              <option value="MOOT">MOOT</option>
              <option value="IA">IA</option>
            </select>
            <button class="btn" style="flex:0 0 200px;" id="admin-create">Create</button>
          </div>
          <div class="empty" style="margin-top:10px;">
            Tip: crée des comptes simples pour le roleplay. Tu peux désactiver un user à tout moment.
          </div>
        </div>

        <div class="section">
          <h4>USERS</h4>
          <div id="admin-users"></div>
        </div>
      </div>
      <div class="resizer" data-resize></div>
    </div>

    <!-- LOGS -->
    <div class="window hidden" id="win-logs" style="top:180px; left: 360px; width: 960px; height: 480px;">
      <div class="titlebar" data-drag>
        <div class="win-title"><span class="miniicon">!</span> SERVER LOGS</div>
        <div class="win-controls">
          <div class="ctl" data-min="win-logs">_</div>
          <div class="ctl" data-close="win-logs">×</div>
        </div>
      </div>
      <div class="content">
        <div class="section">
          <h4>FILTER</h4>
          <div style="display:flex; gap:10px;">
            <input class="field" id="logs-q" placeholder="Filter (action / meta / username) …">
            <button class="btn" style="flex:0 0 180px;" id="logs-refresh">Refresh</button>
          </div>
        </div>
        <div class="section">
          <h4>OUTPUT</h4>
          <pre id="logs-out" style="white-space:pre-wrap;"></pre>
        </div>
      </div>
      <div class="resizer" data-resize></div>
    </div>
  </div>

  <!-- Start menu -->
  <div class="startmenu" id="startmenu">
    <div class="head">
      <div class="t">IA MENU</div>
      <div class="tag">SECURE</div>
    </div>
    <div class="items">
      <div class="menuitem" data-open="win-drive">
        <div class="name">Open Drive</div>
        <div class="desc">All scopes, files & uploads</div>
      </div>
      <div class="menuitem" data-open="win-admin">
        <div class="name">Open User Admin</div>
        <div class="desc">Create / disable / roles / reset</div>
      </div>
      <div class="menuitem" data-open="win-logs">
        <div class="name">Open Logs</div>
        <div class="desc">Global server logs</div>
      </div>
      <div class="menuitem" id="menu-lock">
        <div class="name">Lock Session</div>
        <div class="desc">Return to login screen</div>
      </div>
      <div class="menuitem" id="menu-logout">
        <div class="name">Logout</div>
        <div class="desc">Terminate session</div>
      </div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start" id="startbtn">START</div>
    <div class="tasks" id="tasks"></div>
    <div class="tray">
      <span id="tray-agent">INVESTIGATOR: --</span>
      <span id="tray-time">--:--:--</span>
    </div>
  </div>

  <script>
    // ---- AUTH via PHP session (NO localStorage) ----
    async function requireSessionAndBoot(){
      try{
        const r = await fetch("api.php?action=me", { credentials: "include" });
        const j = await r.json();

        if (!j.ok || !j.user) throw new Error("not-auth");

        const role = String(j.user.role || "").toUpperCase();
        const map = { PI: "desktop_pi.html", MOOT: "desktop_moot.html", IA: "desktop_ia.html" };

        // Mauvais desktop ? -> redirection vers le bon
        if (role !== "IA"){
          location.href = map[role] || "index.html";
          return;
        }

        // User disponible en mémoire (pas localStorage)
        window.FBIOS_USER = j.user;

        // UI identity
        const agent = String(j.user.username || "UNKNOWN").toUpperCase();
        const el = document.getElementById("agent-name");
        if (el) el.textContent = agent;
        const tray = document.getElementById("tray-agent");
        if (tray) tray.textContent = `INVESTIGATOR: ${agent}`;

        // Charger os.js seulement après validation de session
        await new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "os.js";
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });

        // Boot
        if (window.FBIOS && typeof window.FBIOS.bootDesktop === "function"){
          // 2e param optionnel si tu veux l'utiliser plus tard
          window.FBIOS.bootDesktop("IA", window.FBIOS_USER);
        }

        // Afficher l’UI une fois ok
        document.body.style.visibility = "visible";
      }catch(e){
        location.href = "index.html";
      }
    }

    document.addEventListener("DOMContentLoaded", requireSessionAndBoot);
  </script>
</body>
</html>
